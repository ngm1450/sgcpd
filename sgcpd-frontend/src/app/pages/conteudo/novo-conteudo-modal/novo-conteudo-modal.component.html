<div class="modal-backdrop fade" [class.show]="open" *ngIf="open"></div>

<div class="modal fade"
     [class.show]="open"
     [style.display]="open ? 'block' : 'none'"
     tabindex="-1"
     role="dialog"
     aria-modal="true"
     [attr.aria-hidden]="!open"
     (click)="onBackdropClick()"
     (keydown)="onKeydown($event)">

  <div class="modal-dialog modal-lg modal-dialog-centered" role="document" (click)="stop($event)">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title m-0">
          {{ mode === 'edit' ? 'Editar conteúdo' : 'Novo conteúdo' }}
        </h5>
        <button type="button" class="btn-close" aria-label="Fechar" (click)="close()"></button>
      </div>

      <div class="modal-body">

        <div *ngIf="errorConteudo" class="alert alert-danger mb-3">{{ errorConteudo }}</div>

        <form (ngSubmit)="save()" #f="ngForm">

          <div>
            <label class="form-label" for="titulo">Título</label>
            <input id="titulo" type="text"
                   class="form-control"
                   [(ngModel)]="form.titulo"
                   name="titulo"
                   maxlength="30"
                   required />
            <div class="form-text text-end">{{ (form.titulo || '').length }}/30</div>
          </div>

          <div class="mb-3">
            <label class="form-label" for="corpo">Corpo</label>
            <quill-wrapper
              [(value)]="form.corpo">
            </quill-wrapper>
          </div>

          <!-- Categoria + Status -->
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="idCategoria">Categoria</label>
              <select id="idCategoria" class="form-select"
                      [ngModel]="form.idCategoria"
                      (ngModelChange)="onCategoriaChange($event)"
                      name="idCategoria"
                      required
                      [disabled]="loadingCategorias">
                <option [ngValue]="null">Selecione...</option>
                <option *ngFor="let c of categorias" [ngValue]="c.id">{{ c.nome }}</option>
              </select>
              <div *ngIf="loadingCategorias" class="form-text">Carregando categorias…</div>
              <div *ngIf="errorCategorias" class="text-danger small mt-1">{{ errorCategorias }}</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="status">Status</label>
              <select id="status" class="form-select"
                      [(ngModel)]="form.status"
                      name="status">
                <option value="RASCUNHO">Rascunho</option>
                <option value="PUBLICADO">Publicado</option>
                <option value="ARQUIVADO">Arquivado</option>
              </select>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label d-block">Tags</label>

            <div *ngIf="form.idCategoria == null" class="form-text">
              Selecione uma categoria para ver as tags.
            </div>

            <div *ngIf="form.idCategoria != null">
              <div *ngIf="loadingTags" class="form-text">Carregando tags…</div>
              <div *ngIf="errorTags" class="text-danger small mb-2">{{ errorTags }}</div>

              <ng-container *ngIf="!loadingTags && !errorTags">
                <div *ngIf="!tags?.length" class="form-text">Nenhuma tag nesta categoria. Selecione outra.</div>

                <div class="d-flex flex-wrap gap-3" *ngIf="tags?.length">
                  <label class="form-check form-check-inline" *ngFor="let t of tags">
                    <input class="form-check-input"
                           type="checkbox"
                           (input)="toggleTag(t.id, !selectedTagIds.has(t.id))"
                           [checked]="selectedTagIds.has(t.id)">
                    <span class="form-check-label">{{ t.nome }}</span>
                  </label>
                </div>
              </ng-container>
            </div>
          </div>

          <div class="mt-3">
            <label for="anexos" class="form-label">Anexos (opcional)</label>
            <input id="anexos"
                   type="file"
                   class="form-control"
                   (change)="onFilesSelected($event)"
                   multiple />

            <ul class="list-group list-group-flush" *ngIf="files.length">
              <li class="d-flex justify-content-between align-items-center mt-2"
                  *ngFor="let f of files; index as i">
                <span class="text-truncate" style="max-width: 75%;">
                  {{ f.nome }}
                  <small class="text-muted">
                    ({{ f.tamanho / (1024 * 1024) | number:'1.2-2' }} MB)
                  </small>
                </span>

                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeFile(i)">
                    Remover
                  </button>

                  <button
                    *ngIf="f.id"
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    (click)="arquivoService.baixarArquivo(f.id, f.nome)"
                    title="Baixar arquivo">
                    Baixar
                  </button>
                </div>

              </li>
            </ul>
            <div class="form-text">
              Você pode selecionar múltiplos arquivos.
            </div>
          </div>

          <div class="modal-footer px-0">
            <button type="button" class="btn btn-outline-secondary" (click)="close()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="!canSave()">
              {{ mode === 'edit' ? 'Salvar alterações' : 'Salvar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
